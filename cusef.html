
<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
		<title>CUSEF</title>
		<script type="text/javascript" src="http://mbostock.github.com/d3/d3.v2.js"></script>
		<style type="text/css">
		body {
			font-family: "Helvetica";
		}
		.chart {
			shape-rendering: crispEdges;
		}

		.mini text {
			font: 9px sans-serif;	
		}

		.main text {
			font: 12px sans-serif;	
		}

		.miniItem0 {
			fill: darksalmon;
			stroke-width: 6;	
		}

		.miniItem1 {
			fill: darkolivegreen;
			fill-opacity: .7;
			stroke-width: 6;	
		}

		.miniItem2 {
			fill: slategray;
			fill-opacity: .7;
			stroke-width: 6;	
		}

		.brush .extent {
			stroke: gray;
			fill: dodgerblue;
			fill-opacity: .365;
		}

		.foo-circle:hover {
			/* this will be same as highlighted point color variable in JS */
			/* var highlightedPoint = #foobar */
			fill: orange;
		}
		</style>

		<style>
/* http://bl.ocks.org/mbostock/4349486 */
/* for grid thing in mini */
		.grid-background {
		  fill: #ddd;
		}

		.grid line {
		  stroke: steelblue;
		}

		.grid .minor line {
		  stroke-opacity: .5;
		}

		.grid text {
		  display: none;
		}

		.axis line {
		  stroke: #000;
		}

		.axis path,
		.grid path {
		  display: none;
		}

		</style>

		<style>
/* utility classes */
		.opacity-zero {
			opacity: 0;
			display: none;
		}

		.opacity-one {
			opacity: 1;
			display: block;
		}

		</style>
		<style>
			
		#modal {
			position: absolute;
			top: 200;
		    background-color: #FFF;
		    width: 40%;
		    height: 300px;
		    overflow: scroll;
		}
		.modal-left {
			left: 30px;
		}

		.modal-right {
			right: 30px;
		}
		</style>
	</head>
	<body>
		
		<svg id="timeline" style="position: absolute; left:0; top: 0;"></svg>
		<div id="modal" class="opacity-zero">
			<span style="float:right">X</span>
		</div>

		<script type="text/javascript">
		//data
		// var lanes = ["Chinese","Japanese","Korean"],
		var lanes = ["China"],
			laneLength = lanes.length,
			items = [{
				"lane": 0,
				"id": "Sui",
				"start": -250,
				"end": -255,
				"cx": 20,
				"cy": 200, 
				"text": "Foo bar baz"},
				{
					"lane": 0, "id": "Qin", "start": 5, "end": 6, "cx": 120, "cy": 120,
					"text": "Foo bar baz"
				},
				{
					"lane": 0, "id": "Jin", "start": 420, "end": 421, "cx": 220, "cy": 180,
					"text": "<h1>Foo bar baz</h1><p>Lorem ipsum fdsao fds fds a fsda</p>"
				},
				{
					"lane": 0, "id": "Tang", "start": 900, "end": 901, "cx": 520, "cy": 120,
					"text": "<p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Cras ex orci, convallis at sodales nec, iaculis quis tellus. Vivamus nunc odio, fringilla at magna at, euismod facilisis nulla. Aliquam erat volutpat. Aliquam condimentum lectus nunc, dapibus egestas elit imperdiet sit amet. Etiam auctor lacus a auctor convallis. Nullam lacinia risus purus, eu volutpat velit dictum nec. Aenean a vehicula mi. Morbi vel nisi non lacus vehicula facilisis eu ut justo. Aenean nec ante congue, lacinia enim sed, egestas sapien.</p>"
				},
				{
					"lane": 0, "id": "Song", "start": 960, "end": 961, "cx": 260, "cy": 500,
					"text": "Phasellus pellentesque suscipit ligula, at sodales odio placerat id. In nec mi nibh. Nunc quis mauris quis tellus pretium volutpat eget sit amet nibh. Mauris a diam risus."
				},
				{
					"lane": 0, "id": "Yuan", "start": 1270, "end": 1365, "cx": 204, "cy": 333,
					"text": "<h1>Phasellus pellentesque suscipit ligula, at sodales odio placerat id.</h1><p>In nec mi nibh. Nunc quis mauris quis tellus pretium volutpat eget sit amet nibh. Mauris a diam risus.</p>"
				},
				{
					"lane": 0, "id": "Ming", "start": 1370, "end": 1640, "cx": 207, "cy": 454,
					"text": "<h3>Cats!!!</h3><p>Integer sollicitudin ex eu eros mattis, sed iaculis eros malesuada. Donec ex felis, blandit ut odio nec, sodales dignissim metus. Proin sagittis, odio commodo fringilla pulvinar, diam ligula mattis orci, in molestie dui libero in urna. Nulla iaculis leo interdum maximus aliquet. Curabitur hendrerit et diam nec gravida. Suspendisse dictum pharetra lectus, ac congue lorem congue vitae. Suspendisse consectetur sollicitudin aliquam. Proin pulvinar nibh ut sapien ornare egestas. Vivamus viverra risus tempor eleifend sagittis. Aenean malesuada lacus orci, et sollicitudin ante viverra euismod.</p>"
				},
				{
					"lane": 0, "id": "Qing", "start": 1645, "end": 1910, "cx": 340, "cy": 296,
					"text": "<h1>Foo bar baz</h1><p>Lorem ipsum fdsao fds fds a fsda</p>"
				},
				{
					"lane": 0, "id": "Asuka", "start": 550, "end": 700, "cx": 370, "cy": 300,
					"text": "Foo bar baz"
				},
				{
					"lane": 0, "id": "Heian", "start": 800, "end": 1180, "cx": 440, "cy": 232,
					"text": "Integer sollicitudin ex eu eros mattis, sed iaculis eros malesuada. Donec ex felis, blandit ut odio nec, sodales dignissim metus. Proin sagittis, odio commodo fringilla pulvinar, diam ligula mattis orci, in molestie dui libero in urna.</br> Nulla iaculis leo interdum maximus aliquet. Curabitur hendrerit et diam nec gravida. Suspendisse dictum pharetra lectus, ac congue lorem congue vitae. Suspendisse consectetur sollicitudin aliquam. Proin pulvinar nibh ut sapien ornare egestas.</br>Vivamus viverra risus tempor eleifend sagittis. Aenean malesuada lacus orci, et sollicitudin ante viverra euismod."
				},
				{
					"lane": 0, "id": "Kamakura", "start": 1190, "end": 1330, "cx": 340, "cy": 455,
					"text": "<h1>Foo bar baz</h1><p>Lorem ipsum fdsao fds fds a fsda</p>"
				},
				{
					"lane": 0, "id": "Muromachi", "start": 1340, "end": 1560, "cx": 340, "cy": 222,
					"text": "Vivamus et gravida neque, eu dignissim lacus. Nulla maximus nulla et interdum viverra. Aliquam vel erat tristique dui egestas feugiat. Praesent vitae feugiat magna, sit amet ornare nunc. Sed euismod tempor egestas. Ut eros est, placerat id varius eget, vehicula non velit. Interdum et malesuada fames ac ante ipsum primis in faucibus. Aenean sit amet turpis orci."
				},
				{
					"lane": 0, "id": "Edo", "start": 1610, "end": 1860, "cx": 340, "cy": 144,
					"text": "Ut eros est, placerat id varius eget, vehicula non velit. Interdum et malesuada fames ac ante ipsum primis in faucibus. Aenean sit amet turpis orci."
				},
				{
					"lane": 0, "id": "Meiji", "start": 1870, "end": 1900, "cx": 345, "cy": 444,
					"text": "Proin pulvinar nibh ut sapien ornare egestas.</br>Vivamus viverra risus tempor eleifend sagittis. Aenean malesuada lacus orci, et sollicitudin ante viverra euismod."
				},
				{
					"lane": 0, "id": "Taisho", "start": 1910, "end": 1920, "cx": 220, "cy": 124,
					"text": "<h1>Foo bar baz</h1><p>Lorem ipsum fdsao fds fds a fsda</p>"
				},
				{
					"lane": 0, "id": "Showa", "start": 1925, "end": 1985, "cx": 130, "cy": 344,
					"text": "<h1>Foo bar baz</h1><p>Lorem ipsum fdsao fds fds a fsda</p>"
				},
				{
					"lane": 0, "id": "Heisei", "start": 1990, "end": 1995, "cx": 400, "cy": 214,
					"text": "Foo bar baz"
				},
				{
					"lane": 0, "id": "Three Kingdoms", "start": 10, "end": 670, "cx": 340, "cy": 444,
					"text": "<h1>Foo</h1>"
				},
				{
					"lane": 0, "id": "North and South States", "start": 690, "end": 900, "cx": 340, "cy": 444,
					"text": "Foo bar baz"
				},
				{
					"lane": 0, "id": "Goryeo", "start": 920, "end": 1380, "cx": 340, "cy": 234,
					"text": "Aenean malesuada lacus orci, et sollicitudin ante viverra euismod."
				},
				{
					"lane": 0, "id": "Joseon", "start": 1390, "end": 1890, "cx": 370, "cy": 554,
					"text": "Et sollicitudin ante viverra euismod."
				},
					{"lane": 0, "id": "Korean Empire", "start": 1900, "end": 1901, "cx": 20, "cy": 177}
					]
			timeBegin = -300,
			timeEnd = 2000;
		</script>
		<script type="text/javascript">

		var timelineState = {
			currentPoint: ""
		};

		var highlightedPoint = 'orange';
		var unhighlightedPoint = 'blue';


		// var margin = [20, 15, 15, 120], //top right bottom left
		var margin = {top: 20, right: 15, bottom: 15, left: 120},
			w = 960 - margin.right - margin.left,
			h = 500 - margin.top - margin.bottom,
			miniHeight = laneLength * 12 + 50,
			mainHeight = 200 - miniHeight - 50;

		var mapHeight = 600;

		//scales
		var x = d3.scale.linear()
				.domain([timeBegin, timeEnd])
				.range([0, w]);
		var x1 = d3.scale.linear()
				.range([0, w]);
		var y1 = d3.scale.linear()
				.domain([0, laneLength])
				.range([0, mainHeight]);
		var y2 = d3.scale.linear()
				.domain([0, laneLength])
				.range([0, miniHeight]);

		var chart = d3.select("#timeline")
					// .append("svg")
					.attr("width", w + margin.right + margin.left)
					.attr("height", h + margin.top + margin.bottom + mapHeight)
					.attr("class", "chart");
		
		chart.append("defs").append("clipPath")
			.attr("id", "clip")
			.append("rect")
			.attr("width", w)
			.attr("height", mainHeight);

		var map = chart.append('g');

			function hideModal() {
				d3.select('#modal').classed('opacity-zero', true).classed('opacity-one', false);
				d3.selectAll('.foo-circle').style("fill", unhighlightedPoint);
			}

			map.append('image')
					.attr('width', 940)
					.attr('height', mapHeight)
					.attr('x', 0)
					.attr('y', 0)
					.attr('xlink:href', '/images/map.png')
					.on('click', hideModal);

			map.selectAll(".foo-circle")
					.data(items)
				  .enter().append('circle')
				  	.attr('class', 'foo-circle')
					.attr('r', 20)
					.attr('cx', function(d) { return d.cx})
					.attr('cy', function(d) { return d.cy})
					.attr('fill', unhighlightedPoint)
					.on('mouseover', highlightMapPoint)
					.on('mouseout', unhighlightMapPoint)
					.on('click', showModal);
		
		function highlightMapPoint(hoverD) {
			console.warn(hoverD);
			d3.selectAll(".foo-circle").filter(function (d) {return d == hoverD}).style("fill", highlightedPoint);
		}

		function unhighlightMapPoint(hoverD) {
			if (timelineState.currentPoint !== hoverD) {
			  d3.selectAll(".foo-circle").filter(function (d) {return d == hoverD}).style("fill", unhighlightedPoint);
			}
		}

		function showModal(clickD) {
			d3.select("#modal").classed("opacity-zero", false).html(clickD.text);
			timelineState.currentPoint = clickD;
			d3.select(".foo-circle").filter(function (d) {return d == clickD}).style("fill", highlightedPoint);
			d3.selectAll(".foo-circle").filter(function (d) {return d !== clickD}).style("fill", unhighlightedPoint);
			// console.log(d);
		};


		var main = chart.append("g")
					.attr("transform", "translate(" + margin.bottom + "," + (margin.top+mapHeight) + ")")
					.attr("width", w)
					// .attr("height", mainHeight)
					.attr("height", 100)
					.attr("class", "main");

		var mini = chart.append("g")
					.attr("transform", "translate(" + margin.bottom + "," + (mainHeight + margin.top + mapHeight) + ")")
					.attr("width", w)
					.attr("height", miniHeight)
					.attr("class", "mini");
		
		//main lanes and texts
		main.append("g").selectAll(".laneLines")
			.data(items)
			.enter().append("line")
			.attr("x1", margin.right)
			.attr("y1", function(d) {return y1(d.lane);})
			.attr("x2", w)
			.attr("y2", function(d) {return y1(d.lane);})
			.attr("stroke", "lightgray")

		main.append("g").selectAll(".laneText")
			.data(lanes)
			.enter().append("text")
			.text(function(d) {return d;})
			.attr("x", -margin.right)
			.attr("y", function(d, i) {return y1(i + .5);})
			.attr("dy", ".5ex")
			.attr("text-anchor", "end")
			.attr("class", "laneText");
		
		//mini lanes and texts
		mini.append("g").selectAll(".laneLines")
			.data(items)
			.enter().append("line")
			.attr("x1", margin.right)
			.attr("y1", function(d) {return y2(d.lane);})
			.attr("x2", w)
			.attr("y2", function(d) {return y2(d.lane);})
			.attr("stroke", "lightgray");

		mini.append("g").selectAll(".laneText")
			.data(lanes)
			.enter().append("text")
			.text(function(d) {return d;})
			.attr("x", -margin.right)
			.attr("y", function(d, i) {return y2(i + .5);})
			.attr("dy", ".5ex")
			.attr("text-anchor", "end")
			.attr("class", "laneText");

		var itemRects = main.append("g")
							.attr("clip-path", "url(#clip)");
		
		//mini item rects
		mini.append("g").selectAll("miniItems")
			.data(items)
			.enter().append("rect")
			.attr("class", function(d) {return "miniItem" + d.lane;})
			.attr("x", function(d) {return x(d.start);})
			.attr("y", function(d) {return y2(d.lane + .5) - 5;})
			.attr("width", function(d) {return x(d.end - d.start) * (-1);})
			.attr("height", 10);

	    //mini labels
		mini.append("g").selectAll(".miniLabels")
			.data(items)
			.enter().append("circle")
			// .text(function(d) {return d.id;})
			.attr("cx", function(d) {return x(d.start);})
			.attr("cy", function(d) {return y2(d.lane + .5);})
			.attr('r', 5)
			.attr('fill', 'steelblue')
			// .attr("dy", ".5ex");

		mini.append("g")
		    .attr("class", "grid")
		    .attr("transform", "translate(0," + miniHeight + ")")
		    .call(d3.svg.axis().scale(x).ticks(20).tickSize(-miniHeight))
		  .selectAll(".tick")
		    .data(x.ticks(10), function(d) { return d; })
		  .exit();

// axis addition
var x = d3.scale.linear().domain([timeBegin, timeEnd]).range([0, w]);
var x1 = d3.scale.linear().range([0, w]);
// var x1 = d3.scale.linear().range([0, w]);

var xDateAxis = d3.svg.axis()
	.scale(x)
	.orient('bottom')
	// .ticks(d3.time.mondays, (x.domain()[1] - x.domain()[0]) > 15552e6 ? 2 : 1)
	// .tickFormat(d3.time.format('%d'))
	.tickSize(0);

var x1DateAxis = d3.svg.axis()
	.scale(x1)
	.orient('top');

main.append('g')
	.attr('transform', 'translate(0,' + (mainHeight) + ')')
	.attr('class', 'main axis date')
	.call(x1DateAxis);

mini.append('g')
	.attr('transform', 'translate(0,' + miniHeight + ')')
	.attr('class', 'axis date')
	.call(xDateAxis);

	var timeRange = d3.extent(items.map(function(d) {return d.start}));

		//brush
		var brush = d3.svg.brush()
							.extent(timeRange)
							.x(x)
							.on("brush", display);

		mini.append("g")
			.attr("class", "x brush")
			.call(brush)
			.selectAll("rect")
			.attr("y", 1)
			.attr("height", miniHeight - 1);

		display();
		
		function display() {
			var rects, labels,
				minExtent = brush.extent()[0],
				maxExtent = brush.extent()[1],
				visItems = items.filter(function(d) {return d.start < maxExtent && d.end > minExtent;});

			mini.select(".brush")
				.call(brush.extent([minExtent, maxExtent]));

			x1.domain([minExtent, maxExtent]);

// update axis?
main.select('.main.axis.date').call(x1DateAxis);

			lines = itemRects.selectAll("line")
				.data(visItems, function (d) { return d.id; })
				.attr("x1", function(d) {return x1(d.start + 2);})
				.attr("x2", function(d) {return x1(d.start + 2);});

			lines.enter().append("line")
				.attr("x1", function(d) {return x1(d.start + 2);})
				.attr("x2", function(d) {return x1(d.start + 2);})
				.attr("y1", 0)
				.attr("y2", 100)
				.attr("stroke-width", 2)
				.attr("stroke", "orangered")

			lines.exit().remove();
// WORKING ON THIS SECTION
			// function highlightMapPoint(hoverD) {
			// 	console.warn(hoverD);
			// 	d3.selectAll(".foo-circle").filter(function (d) {return d == hoverD}).style("fill", highlightedPoint);
			// }

			// function unhighlightMapPoint(hoverD) {
			// 	if (timelineState.currentPoint !== hoverD) {
			// 	  d3.selectAll(".foo-circle").filter(function (d) {return d == hoverD}).style("fill", unhighlightedPoint);
			// 	}
			// }

			circles = itemRects.selectAll("circle")
				.data(visItems, function (d) { return d.id; })
				.attr("cx", function(d) {return x1(d.start + 2);});

			circles.enter().append("circle")
				.attr("cx", function(d) {return x1(Math.max(d.start, minExtent));})
				.attr("cy", function(d) {return y1(d.lane + .5);})
				.attr("r", 11)
				.attr("fill", "steelblue")
				.on('click', showModal)
				.on('mouseover', highlightMapPoint)
				.on("mouseout", unhighlightMapPoint);	

			circles.exit().remove();

			shmabels = itemRects.selectAll("text")
				.data(visItems, function (d) { return d.id; })
				.attr("x", function(d) {return x1(d.start + 2);});

			shmabels.enter().append("text")
				.text(function(d) {return "i";})
				.attr("fill", "#FFF")
				.style('font-style', "italic")
				.style('font-size', 18)
				.attr("dy", ".5ex")
				.attr("dx", "-.3ex")
				.attr("x", function(d) {return x1(Math.max(d.start, minExtent));})
				.attr("y", function(d) {return y1(d.lane + .5);})
				
			shmabels.exit().remove();

			var e = brush.extent();
	
			d3.selectAll(".foo-circle")
      			.style("display", function (d) { 
      				console.log(e); 
      				return d.start >= e[0] && d.start <= e[1] ? "block" : "none";
      			});

				
		}
		
		</script>
	</body>
</html>
